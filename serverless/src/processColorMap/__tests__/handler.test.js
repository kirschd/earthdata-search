import AWS from 'aws-sdk'

import nock from 'nock'
import knex from 'knex'
import mockKnex from 'mock-knex'

import * as getDbConnection from '../../util/database/getDbConnection'

import processColorMap from '../handler'

import { colorMapOne } from './mocks'

let dbTracker

const sqsColorMap = jest.fn().mockReturnValue({
  promise: jest.fn().mockResolvedValue()
})

AWS.SQS = jest.fn()
  .mockImplementationOnce(() => ({
    sendMessage: sqsColorMap
  }))

beforeEach(() => {
  jest.clearAllMocks()

  jest.spyOn(getDbConnection, 'getDbConnection').mockImplementationOnce(() => {
    const dbCon = knex({
      client: 'pg',
      debug: false
    })

    // Mock the db connection
    mockKnex.mock(dbCon)

    return dbCon
  })

  dbTracker = mockKnex.getTracker()
  dbTracker.install()
})

afterEach(() => {
  dbTracker.uninstall()
})

describe('processColorMap', () => {
  test('inserts the correct records into the database', async () => {
    nock(/gibs/)
      .get(/VIIRS_Angstrom_Exponent_Deep_Blue/)
      .reply(200, colorMapOne)

    dbTracker.on('query', (query) => {
      query.response([])
    })

    await processColorMap({
      Records: [{
        body: JSON.stringify({
          id: 1,
          product: 'VIIRS_Angstrom_Exponent_Deep_Blue',
          url: 'https://gibs.earthdata.nasa.gov/colormaps/v1.3/VIIRS_Angstrom_Exponent_Deep_Blue.xml'
        })
      }]
    }, {})

    const { queries } = dbTracker.queries

    expect(queries[0].bindings).toEqual([{
      id: 'VIIRS_Angstrom_Exponent_Deep_Blue',
      scale: {
        colors: [
          '#7a8f02',
          '#7a9102',
          '#7b9403',
          '#7c9604',
          '#7c9905',
          '#7d9b06',
          '#7e9e07',
          '#7fa008',
          '#7fa309',
          '#80a50a',
          '#81a80b',
          '#82aa0c',
          '#82ad0d',
          '#83af0e',
          '#84b20f',
          '#85b510',
          '#84b712',
          '#84b914',
          '#84bb16',
          '#84bd19',
          '#84bf1b',
          '#84c11d',
          '#84c31f',
          '#83c522',
          '#83c724',
          '#83c926',
          '#83cb28',
          '#83cd2b',
          '#83cf2d',
          '#83d12f',
          '#83d432',
          '#82d533',
          '#81d735',
          '#80d937',
          '#80db39',
          '#7fdd3b',
          '#7ede3d',
          '#7de03f',
          '#7de240',
          '#7ce442',
          '#7be644',
          '#7ae746',
          '#7ae948',
          '#79eb4a',
          '#78ed4c',
          '#78ef4e',
          '#77ef4f',
          '#76f050',
          '#75f152',
          '#74f253',
          '#74f355',
          '#73f456',
          '#72f557',
          '#71f659',
          '#70f75a',
          '#70f85c',
          '#6ff95d',
          '#6efa5e',
          '#6dfb60',
          '#6cfc61',
          '#6cfd63',
          '#6bfc64',
          '#6afc66',
          '#6afc67',
          '#69fb69',
          '#69fb6a',
          '#68fb6c',
          '#67fb6d',
          '#67fa6f',
          '#66fa70',
          '#66fa72',
          '#65fa73',
          '#64f975',
          '#64f976',
          '#63f978',
          '#63f97a',
          '#62f77b',
          '#61f67c',
          '#60f57e',
          '#5ff47f',
          '#5ef380',
          '#5df282',
          '#5cf183',
          '#5cef84',
          '#5bee86',
          '#5aed87',
          '#59ec88',
          '#58eb8a',
          '#57ea8b',
          '#56e98c',
          '#56e88e',
          '#55e68f',
          '#54e590',
          '#53e491',
          '#52e293',
          '#51e194',
          '#50e095',
          '#4fdf96',
          '#4edd98',
          '#4ddc99',
          '#4cdb9a',
          '#4bda9b',
          '#4ad89d',
          '#49d79e',
          '#48d69f',
          '#48d5a1',
          '#47d3a2',
          '#46d1a3',
          '#45d0a4',
          '#44cea5',
          '#43cda6',
          '#42cba7',
          '#41c9a8',
          '#40c8aa',
          '#3fc6ab',
          '#3ec5ac',
          '#3dc3ad',
          '#3cc1ae',
          '#3bc0af',
          '#3abeb0',
          '#3abdb2',
          '#3abbb2',
          '#3ab9b3',
          '#3ab8b4',
          '#3ab6b5',
          '#3ab5b6',
          '#3ab3b7',
          '#3ab2b8',
          '#3bb0b8',
          '#3bafb9',
          '#3badba',
          '#3bacbb',
          '#3baabc',
          '#3ba9bd',
          '#3ba7be',
          '#3ca6bf',
          '#3ca4bf',
          '#3da2c0',
          '#3da0c1',
          '#3e9ec2',
          '#3f9cc3',
          '#3f9ac3',
          '#4098c4',
          '#4096c5',
          '#4194c6',
          '#4292c7',
          '#4290c7',
          '#438ec8',
          '#438cc9',
          '#448aca',
          '#4589cb',
          '#4587cb',
          '#4685cc',
          '#4683cd',
          '#4781cd',
          '#4880ce',
          '#487ecf',
          '#497ccf',
          '#497ad0',
          '#4a78d1',
          '#4b77d1',
          '#4b75d2',
          '#4c73d3',
          '#4c71d3',
          '#4d6fd4',
          '#4e6ed5',
          '#4e6cd5',
          '#4f6ad6',
          '#5068d6',
          '#5066d7',
          '#5165d8',
          '#5263d8',
          '#5261d9',
          '#535fd9',
          '#545dda',
          '#545cdb',
          '#555adb',
          '#5658dc',
          '#5656dc',
          '#5754dd',
          '#5853de',
          '#5852de',
          '#5951df',
          '#5a50df',
          '#5b50e0',
          '#5c4fe0',
          '#5d4ee1',
          '#5e4de1',
          '#5f4de2',
          '#604ce2',
          '#614be3',
          '#624ae3',
          '#634ae4',
          '#6449e4',
          '#6548e5',
          '#6648e6',
          '#6848e6',
          '#6a49e6',
          '#6c49e6',
          '#6e4ae7',
          '#704ae7',
          '#724be7',
          '#744be7',
          '#764ce8',
          '#784ce8',
          '#7a4de8',
          '#7c4de8',
          '#7e4ee9',
          '#804ee9',
          '#824fe9',
          '#8550ea',
          '#8750ea',
          '#8950ea',
          '#8b51ea',
          '#8d51ea',
          '#8f51ea',
          '#9152ea',
          '#9352ea',
          '#9552ea',
          '#9753ea',
          '#9953ea',
          '#9b53ea',
          '#9d54ea',
          '#9f54ea',
          '#a154ea',
          '#a455eb',
          '#a555eb',
          '#a655eb',
          '#a855eb',
          '#a955eb',
          '#ab55eb',
          '#ac55eb',
          '#ae55eb',
          '#af56eb',
          '#b156eb',
          '#b256eb',
          '#b456eb',
          '#b556eb',
          '#b756eb',
          '#b856eb',
          '#ba57eb',
          '#bb57ea',
          '#bc57ea',
          '#be57ea',
          '#bf58ea',
          '#c158ea',
          '#c258ea',
          '#c458ea',
          '#c559ea',
          '#c759ea',
          '#c859ea',
          '#ca59ea'
        ],
        labels: [
          '< 0.00',
          '0 – 0.01',
          '0.01 – 0.02',
          '0.02 – 0.03',
          '0.03 – 0.04',
          '0.04 – 0.05',
          '0.05 – 0.06',
          '0.06 – 0.07',
          '0.07 – 0.08',
          '0.08 – 0.09',
          '0.09 – 0.10',
          '0.10 – 0.11',
          '0.11 – 0.12',
          '0.12 – 0.13',
          '0.13 – 0.14',
          '0.14 – 0.15',
          '0.15 – 0.16',
          '0.16 – 0.17',
          '0.17 – 0.18',
          '0.18 – 0.19',
          '0.19 – 0.20',
          '0.20 – 0.21',
          '0.21 – 0.22',
          '0.22 – 0.23',
          '0.23 – 0.24',
          '0.24 – 0.25',
          '0.25 – 0.26',
          '0.26 – 0.27',
          '0.27 – 0.28',
          '0.28 – 0.29',
          '0.29 – 0.30',
          '0.30 – 0.31',
          '0.31 – 0.32',
          '0.32 – 0.33',
          '0.33 – 0.34',
          '0.34 – 0.35',
          '0.35 – 0.36',
          '0.36 – 0.37',
          '0.37 – 0.38',
          '0.38 – 0.39',
          '0.39 – 0.40',
          '0.40 – 0.41',
          '0.41 – 0.42',
          '0.42 – 0.43',
          '0.43 – 0.44',
          '0.44 – 0.45',
          '0.45 – 0.46',
          '0.46 – 0.47',
          '0.47 – 0.48',
          '0.48 – 0.49',
          '0.49 – 0.50',
          '0.50 – 0.51',
          '0.51 – 0.52',
          '0.52 – 0.53',
          '0.53 – 0.54',
          '0.54 – 0.55',
          '0.55 – 0.56',
          '0.56 – 0.57',
          '0.57 – 0.58',
          '0.58 – 0.59',
          '0.59 – 0.60',
          '0.60 – 0.61',
          '0.61 – 0.62',
          '0.62 – 0.63',
          '0.63 – 0.64',
          '0.64 – 0.65',
          '0.65 – 0.66',
          '0.66 – 0.67',
          '0.67 – 0.68',
          '0.68 – 0.69',
          '0.69 – 0.70',
          '0.70 – 0.71',
          '0.71 – 0.72',
          '0.72 – 0.73',
          '0.73 – 0.74',
          '0.74 – 0.75',
          '0.75 – 0.76',
          '0.76 – 0.77',
          '0.77 – 0.78',
          '0.78 – 0.79',
          '0.79 – 0.80',
          '0.80 – 0.81',
          '0.81 – 0.82',
          '0.82 – 0.83',
          '0.83 – 0.84',
          '0.84 – 0.85',
          '0.85 – 0.86',
          '0.86 – 0.87',
          '0.87 – 0.88',
          '0.88 – 0.89',
          '0.89 – 0.90',
          '0.90 – 0.91',
          '0.91 – 0.92',
          '0.92 – 0.93',
          '0.93 – 0.94',
          '0.94 – 0.95',
          '0.95 – 0.96',
          '0.96 – 0.97',
          '0.97 – 0.98',
          '0.98 – 0.99',
          '0.99 – 1',
          '1 – 1.01',
          '1.01 – 1.02',
          '1.02 – 1.03',
          '1.03 – 1.04',
          '1.04 – 1.05',
          '1.05 – 1.06',
          '1.06 – 1.07',
          '1.07 – 1.08',
          '1.08 – 1.09',
          '1.09 – 1.10',
          '1.10 – 1.11',
          '1.11 – 1.12',
          '1.12 – 1.13',
          '1.13 – 1.14',
          '1.14 – 1.15',
          '1.15 – 1.16',
          '1.16 – 1.17',
          '1.17 – 1.18',
          '1.18 – 1.19',
          '1.19 – 1.20',
          '1.20 – 1.21',
          '1.21 – 1.22',
          '1.22 – 1.23',
          '1.23 – 1.24',
          '1.24 – 1.25',
          '1.25 – 1.26',
          '1.26 – 1.27',
          '1.27 – 1.28',
          '1.28 – 1.29',
          '1.29 – 1.30',
          '1.30 – 1.31',
          '1.31 – 1.32',
          '1.32 – 1.33',
          '1.33 – 1.34',
          '1.34 – 1.35',
          '1.35 – 1.36',
          '1.36 – 1.37',
          '1.37 – 1.38',
          '1.38 – 1.39',
          '1.39 – 1.40',
          '1.40 – 1.41',
          '1.41 – 1.42',
          '1.42 – 1.43',
          '1.43 – 1.44',
          '1.44 – 1.45',
          '1.45 – 1.46',
          '1.46 – 1.47',
          '1.47 – 1.48',
          '1.48 – 1.49',
          '1.49 – 1.50',
          '1.50 – 1.51',
          '1.51 – 1.52',
          '1.52 – 1.53',
          '1.53 – 1.54',
          '1.54 – 1.55',
          '1.55 – 1.56',
          '1.56 – 1.57',
          '1.57 – 1.58',
          '1.58 – 1.59',
          '1.59 – 1.60',
          '1.60 – 1.61',
          '1.61 – 1.62',
          '1.62 – 1.63',
          '1.63 – 1.64',
          '1.64 – 1.65',
          '1.65 – 1.66',
          '1.66 – 1.67',
          '1.67 – 1.68',
          '1.68 – 1.69',
          '1.69 – 1.70',
          '1.70 – 1.71',
          '1.71 – 1.72',
          '1.72 – 1.73',
          '1.73 – 1.74',
          '1.74 – 1.75',
          '1.75 – 1.76',
          '1.76 – 1.77',
          '1.77 – 1.78',
          '1.78 – 1.79',
          '1.79 – 1.80',
          '1.80 – 1.81',
          '1.81 – 1.82',
          '1.82 – 1.83',
          '1.83 – 1.84',
          '1.84 – 1.85',
          '1.85 – 1.86',
          '1.86 – 1.87',
          '1.87 – 1.88',
          '1.88 – 1.89',
          '1.89 – 1.90',
          '1.90 – 1.91',
          '1.91 – 1.92',
          '1.92 – 1.93',
          '1.93 – 1.94',
          '1.94 – 1.95',
          '1.95 – 1.96',
          '1.96 – 1.97',
          '1.97 – 1.98',
          '1.98 – 1.99',
          '1.99 – 2',
          '2 – 2.01',
          '2.01 – 2.02',
          '2.02 – 2.03',
          '2.03 – 2.04',
          '2.04 – 2.05',
          '2.05 – 2.06',
          '2.06 – 2.07',
          '2.07 – 2.08',
          '2.08 – 2.09',
          '2.09 – 2.10',
          '2.10 – 2.11',
          '2.11 – 2.12',
          '2.12 – 2.13',
          '2.13 – 2.14',
          '2.14 – 2.15',
          '2.15 – 2.16',
          '2.16 – 2.17',
          '2.17 – 2.18',
          '2.18 – 2.19',
          '2.19 – 2.20',
          '2.20 – 2.21',
          '2.21 – 2.22',
          '2.22 – 2.23',
          '2.23 – 2.24',
          '2.24 – 2.25',
          '2.25 – 2.26',
          '2.26 – 2.27',
          '2.27 – 2.28',
          '2.28 – 2.29',
          '2.29 – 2.30',
          '2.30 – 2.31',
          '2.31 – 2.32',
          '2.32 – 2.33',
          '2.33 – 2.34',
          '2.34 – 2.35',
          '2.35 – 2.36',
          '2.36 – 2.37',
          '2.37 – 2.38',
          '2.38 – 2.39',
          '2.39 – 2.40',
          '2.40 – 2.41',
          '2.41 – 2.42',
          '2.42 – 2.43',
          '2.43 – 2.44',
          '2.44 – 2.45',
          '2.45 – 2.46',
          '2.46 – 2.47',
          '2.47 – 2.48',
          '2.48 – 2.49',
          '2.49 – 2.50',
          '≥ 2.50'
        ],
        values: [
          -1,
          0,
          0,
          0.01,
          0.01,
          0.02,
          0.02,
          0.03,
          0.03,
          0.04,
          0.04,
          0.05,
          0.05,
          0.06,
          0.06,
          0.07,
          0.07,
          0.08,
          0.08,
          0.09,
          0.09,
          0.1,
          0.1,
          0.11,
          0.11,
          0.12,
          0.12,
          0.13,
          0.13,
          0.14,
          0.14,
          0.15,
          0.15,
          0.16,
          0.16,
          0.17,
          0.17,
          0.18,
          0.18,
          0.19,
          0.19,
          0.2,
          0.2,
          0.21,
          0.21,
          0.22,
          0.22,
          0.23,
          0.23,
          0.24,
          0.24,
          0.25,
          0.25,
          0.26,
          0.26,
          0.27,
          0.27,
          0.28,
          0.28,
          0.29,
          0.29,
          0.3,
          0.3,
          0.31,
          0.31,
          0.32,
          0.32,
          0.33,
          0.33,
          0.34,
          0.34,
          0.35,
          0.35,
          0.36,
          0.36,
          0.37,
          0.37,
          0.38,
          0.38,
          0.39,
          0.39,
          0.4,
          0.4,
          0.41,
          0.41,
          0.42,
          0.42,
          0.43,
          0.43,
          0.44,
          0.44,
          0.45,
          0.45,
          0.46,
          0.46,
          0.47,
          0.47,
          0.48,
          0.48,
          0.49,
          0.49,
          0.5,
          0.5,
          0.51,
          0.51,
          0.52,
          0.52,
          0.53,
          0.53,
          0.54,
          0.54,
          0.55,
          0.55,
          0.56,
          0.56,
          0.57,
          0.57,
          0.58,
          0.58,
          0.59,
          0.59,
          0.6,
          0.6,
          0.61,
          0.61,
          0.62,
          0.62,
          0.63,
          0.63,
          0.64,
          0.64,
          0.65,
          0.65,
          0.66,
          0.66,
          0.67,
          0.67,
          0.68,
          0.68,
          0.69,
          0.69,
          0.7,
          0.7,
          0.71,
          0.71,
          0.72,
          0.72,
          0.73,
          0.73,
          0.74,
          0.74,
          0.75,
          0.75,
          0.76,
          0.76,
          0.77,
          0.77,
          0.78,
          0.78,
          0.79,
          0.79,
          0.8,
          0.8,
          0.81,
          0.81,
          0.82,
          0.82,
          0.83,
          0.83,
          0.84,
          0.84,
          0.85,
          0.85,
          0.86,
          0.86,
          0.87,
          0.87,
          0.88,
          0.88,
          0.89,
          0.89,
          0.9,
          0.9,
          0.91,
          0.91,
          0.92,
          0.92,
          0.93,
          0.93,
          0.94,
          0.94,
          0.95,
          0.95,
          0.96,
          0.96,
          0.97,
          0.97,
          0.98,
          0.98,
          0.99,
          0.99,
          1,
          1,
          1.01,
          1.01,
          1.02,
          1.02,
          1.03,
          1.03,
          1.04,
          1.04,
          1.05,
          1.05,
          1.06,
          1.06,
          1.07,
          1.07,
          1.08,
          1.08,
          1.09,
          1.09,
          1.1,
          1.1,
          1.11,
          1.11,
          1.12,
          1.12,
          1.13,
          1.13,
          1.14,
          1.14,
          1.15,
          1.15,
          1.16,
          1.16,
          1.17,
          1.17,
          1.18,
          1.18,
          1.19,
          1.19,
          1.2,
          1.2,
          1.21,
          1.21,
          1.22,
          1.22,
          1.23,
          1.23,
          1.24,
          1.24,
          1.25,
          1.25,
          1.26,
          1.26,
          1.27,
          1.27,
          1.28,
          1.28,
          1.29,
          1.29,
          1.3,
          1.3,
          1.31,
          1.31,
          1.32,
          1.32,
          1.33,
          1.33,
          1.34,
          1.34,
          1.35,
          1.35,
          1.36,
          1.36,
          1.37,
          1.37,
          1.38,
          1.38,
          1.39,
          1.39,
          1.4,
          1.4,
          1.41,
          1.41,
          1.42,
          1.42,
          1.43,
          1.43,
          1.44,
          1.44,
          1.45,
          1.45,
          1.46,
          1.46,
          1.47,
          1.47,
          1.48,
          1.48,
          1.49,
          1.49,
          1.5,
          1.5,
          1.51,
          1.51,
          1.52,
          1.52,
          1.53,
          1.53,
          1.54,
          1.54,
          1.55,
          1.55,
          1.56,
          1.56,
          1.57,
          1.57,
          1.58,
          1.58,
          1.59,
          1.59,
          1.6,
          1.6,
          1.61,
          1.61,
          1.62,
          1.62,
          1.63,
          1.63,
          1.64,
          1.64,
          1.65,
          1.65,
          1.66,
          1.66,
          1.67,
          1.67,
          1.68,
          1.68,
          1.69,
          1.69,
          1.7,
          1.7,
          1.71,
          1.71,
          1.72,
          1.72,
          1.73,
          1.73,
          1.74,
          1.74,
          1.75,
          1.75,
          1.76,
          1.76,
          1.77,
          1.77,
          1.78,
          1.78,
          1.79,
          1.79,
          1.8,
          1.8,
          1.81,
          1.81,
          1.82,
          1.82,
          1.83,
          1.83,
          1.84,
          1.84,
          1.85,
          1.85,
          1.86,
          1.86,
          1.87,
          1.87,
          1.88,
          1.88,
          1.89,
          1.89,
          1.9,
          1.9,
          1.91,
          1.91,
          1.92,
          1.92,
          1.93,
          1.93,
          1.94,
          1.94,
          1.95,
          1.95,
          1.96,
          1.96,
          1.97,
          1.97,
          1.98,
          1.98,
          1.99,
          1.99,
          2,
          2,
          2.01,
          2.01,
          2.02,
          2.02,
          2.03,
          2.03,
          2.04,
          2.04,
          2.05,
          2.05,
          2.06,
          2.06,
          2.07,
          2.07,
          2.08,
          2.08,
          2.09,
          2.09,
          2.1,
          2.1,
          2.11,
          2.11,
          2.12,
          2.12,
          2.13,
          2.13,
          2.14,
          2.14,
          2.15,
          2.15,
          2.16,
          2.16,
          2.17,
          2.17,
          2.18,
          2.18,
          2.19,
          2.19,
          2.2,
          2.2,
          2.21,
          2.21,
          2.22,
          2.22,
          2.23,
          2.23,
          2.24,
          2.24,
          2.25,
          2.25,
          2.26,
          2.26,
          2.27,
          2.27,
          2.28,
          2.28,
          2.29,
          2.29,
          2.3,
          2.3,
          2.31,
          2.31,
          2.32,
          2.32,
          2.33,
          2.33,
          2.34,
          2.34,
          2.35,
          2.35,
          2.36,
          2.36,
          2.37,
          2.37,
          2.38,
          2.38,
          2.39,
          2.39,
          2.4,
          2.4,
          2.41,
          2.41,
          2.42,
          2.42,
          2.43,
          2.43,
          2.44,
          2.44,
          2.45,
          2.45,
          2.46,
          2.46,
          2.47,
          2.47,
          2.48,
          2.48,
          2.49,
          2.49,
          2.5,
          2.5
        ]
      }
    }, 1])
  })
})
